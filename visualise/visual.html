<!DOCTYPE html>
<html>
<head>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <div id="viz"></div>
    <script type="text/javascript">

    var globalSVG = d3.select("#viz")
        .append("svg")
        .attr("width", 800)
        .attr("height", 800);    

        //.on("mouseover", function(){d3.select(this).style("fill", "aliceblue");})
        //.on("mouseout", function(){d3.select(this).style("fill", "white");});

    function Rectangle(_id, _x, _y, _width, _height, _data){

        this.id = _id;

        this.set = function(_x, _y, _width, _height, _data){
            this.x = _x;
            this.y = _y;
            this.width = _width;
            this.height = _height;
            this.data = _data;
            this.lastUpdated = new Date().getTime();
        }

        this.set(_x, _y, _width, _height, _data);

        this.rect = globalSVG.append("rect")
            .attr("x",this.x)
            .attr("y",this.y)
            .attr("width",this.width)
            .attr("height",this.height)
            //.style("fill", this.fill)
            //.style("stroke",this.stroke)

        this.info = globalSVG.append("text")
            .attr("x", this.x)
            .attr("y", this.y)
            .text(this.id)
            .attr("dy", ".3em"); // all

        this.update = function(_x, _y, _width, _height, _data){
            
            this.set(_x, _y, _width, _height, _data);
            this.rect.transition()
                .attr("x",this.x)
                .attr("y",this.y)
                .attr("width",this.width)
                .attr("height",this.height)
                .duration(1000); //2s all
            //this.info.transition().duration( 0 );
            this.info.transition()
                .attr("x", this.x)
                .attr("y", this.y)
                .text(this.id)
                .duration(1000); 
        }
        
        this.remove = function(){
            this.rect.remove();
            this.info.remove();
        }
    }
    var rects = new Array();
    function clean_rects(){
        var now = new Date().getTime();
        console.log("-- cleanup --"+now);
        for (var r in rects){
            if (now - rects[r].lastUpdated > 5000){
                console.log("-- remove--"+rects[r].id);
                rects[r].remove();
                delete rects[r].id;
            }
        }
    }

    </script>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
        function connectws(){
            console.log("connect");

            ws = new WebSocket("ws://localhost:9997");
            ws.onmessage = function (evt){
                //console.log("--->"+evt.data);
                
                //document.getElementById('datatable').html(evt.data);
            	  
                setInterval(clean_rects(), 3000);

                var report = JSON.parse(evt.data);
                var r = new Array(), j = -1;
                for (var zone in report){//if (report.hasOwnProperty(zone)){
                    id = report[zone]['id']
                    x = report[zone]['x'];
                    y = report[zone]['y'];
                    width = report[zone]['width'];
                    height = report[zone]['height'];

                    r[++j] ='<tr><td>';
                    r[++j] = id;
                    r[++j] = '</td><td>';
                    r[++j] = x;
                    r[++j] = '</td><td>';
                    r[++j] = y;
                    r[++j] = '</td><td>';
                    r[++j] = width;
                    r[++j] = '</td><td>';
                    r[++j] = height;
                    r[++j] = '</td><td>';
                    r[++j] = report[zone]['bc_x'];
                    r[++j] = '</td><td>';
                    r[++j] = report[zone]['bc_y'];
                    r[++j] = '</td></tr>';
                    if(!rects.hasOwnProperty(id)){
                        rects[id]= new Rectangle(id, x, y, width, height, 's'); 
                    }
                    else{
                        rects[id].update(x, y, width, height, 'ss');
                    }
                }//}
                var s = "<table cellspacing='0'> <tr><th>Id</th><th>x</th><th>y</th><th>width</th><th>height</th><th>bc x</th><th>bc y</th></tr></thead><tbody>"+r.join('')+"</tbody></table>";
                document.getElementById('datatable').innerHTML = (s);             };
            ws.onclose = function(){
                console.log("not ok");
                document.getElementById('datatable').innerHTML = "disc";
                //$("#datatable").html("disconnected");
                setInterval(function() {;}, 10000);
                connectws();
            }
            ws.onopen = function(){
                document.getElementById('datatable').innerHTML = ("connected");
            }
        }
        connectws(); 
    </script>
     ok
    <div id="datatable" style="width: 500px; float:left;"></div>
</body>
</html>